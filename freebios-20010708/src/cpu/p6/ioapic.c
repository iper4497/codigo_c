#include <printk.h>
/* TODO: this must move to chip/intel */
/* we have to do more than we thought. I assumed Linux would do all the
 * interesting parts, and I was wrong. 
 */
struct ioapicreg {
	unsigned int reg;
	unsigned int value;
};

struct ioapicreg ioapicregvalues[] = {
	{0x10, 0x10000}, {0x11, 0x0},
	{0x12, 0x959}, {0x13, 0xff000000},
	{0x14, 0x951}, {0x15, 0xff000000},
	{0x16, 0x961}, {0x17, 0x0},
	{0x18, 0x969}, {0x19, 0xff000000},
	{0x1a, 0x971}, {0x1b, 0x0},
	{0x1c, 0x979}, {0x1d, 0x0},
	{0x1e, 0x981}, {0x1f, 0x0},
	{0x20, 0x989}, {0x21, 0xff000000},
	{0x22, 0x10000}, {0x23, 0x0},
	{0x24, 0x10000}, {0x25, 0x0},
	{0x26, 0x10000}, {0x27, 0x0},
	{0x28, 0x991}, {0x29, 0xff000000},
	{0x2a, 0x10000}, {0x2b, 0x0},
	{0x2c, 0x999}, {0x2d, 0x0},
	{0x2e, 0x9a1}, {0x2f, 0x0},
	{0x30, 0x10000}, {0x31, 0x0},
	{0x32, 0x10000}, {0x33, 0x0},
	{0x34, 0x10000}, {0x35, 0x0},
	{0x36, 0xa9a9}, {0x37, 0xff000000},
	{0x38, 0x10000}, {0x39, 0x0},
	{0x3a, 0xa9b1}, {0x3b, 0xff000000},
	{0x3c, 0x10000}, {0x3d, 0x0},
	{0x3e, 0x10000}, {0x3f, 0x0}
};

void setup_ioapic()
{
	int i;
	unsigned long l1;
	unsigned long nvram = 0xfec00000;
	volatile unsigned long *l;
	struct ioapicreg *a = ioapicregvalues;

	l = (unsigned long *) nvram;
	for (i = 0; i < sizeof(ioapicregvalues) / sizeof(ioapicregvalues[0]);
	     i++, a++) {
		*l = a->reg;
		l[4] = a->value;
		l1 = l[4];
		if ((i==0) && (l1 == 0xffffffff)) {
			DBG("IO APIC not responding.\n");
			return;
		}
		DBG("for IRQ, reg 0x%08x value 0x%08x\n", a->reg, l1);
	}
}
